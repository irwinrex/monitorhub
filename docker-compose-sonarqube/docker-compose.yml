services:
  # --- Database ---
  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_DB=sonarqube
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sonar -d sonarqube"]
      interval: 5s
    secrets:
      - postgres_password

  # --- SonarQube ---
  sonarqube:
    image: sonarqube:community
    depends_on:
      db:
        condition: service_healthy
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://db:5432/sonarqube
      - SONAR_JDBC_USERNAME=sonar
    secrets:
      - postgres_password
    volumes:
      - sonar_data:/opt/sonarqube/data
      - sonar_extensions:/opt/sonarqube/extensions
      - sonar_logs:/opt/sonarqube/logs
    entrypoint:
      - sh
      - -c
      - |
        export SONAR_JDBC_PASSWORD="$(cat /run/secrets/postgres_password)"
        exec /opt/sonarqube/docker/entrypoint.sh
    deploy:
      resources:
        limits:
          memory: 2G
    restart: unless-stopped

  # --- GitHub Runner ---
  # github-runner:
  #   image: myoung34/github-runner:latest
  #   environment:
  #     - REPO_URL=
  #     - RUNNER_TOKEN_FILE=/run/secrets/github_token
  #     - RUNNER_NAME=sonar-scanner-runner
  #     - RUNNER_LABELS=self-hosted,security-scanner
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     - runner_data:/data
  #   restart: unless-stopped
  #   secrets:
  #     - github_token

  # --- NGINX Reverse Proxy ---
  nginx:
    image: nginx:alpine
    depends_on:
      - sonarqube
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

volumes:
  postgres_data:
  sonar_data:
  sonar_extensions:
  sonar_logs:
  runner_data:

secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
  github_token:
    file: ./secrets/github_token.txt
