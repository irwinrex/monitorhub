name: Security Scan
on: [push]

jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Run Trivy and output in a format SonarQube understands
      - name: Trivy Scan
        run: |
          docker run --rm -v $(pwd):/path aquasec/trivy:latest \
          fs --format sarif --output /path/trivy-results.sarif /path

      # Upload everything to SonarQube
      - name: SonarQube Analysis
        run: |
          docker run --rm \
            -e SONAR_HOST_URL="http://sonarqube:9000" \
            -e SONAR_TOKEN="${{ secrets.SONAR_TOKEN }}" \
            -v "$(pwd):/usr/src" \
            sonarsource/sonar-scanner-cli \
            -Dsonar.projectKey=my-app \
            -Dsonar.sarifReportPaths=trivy-results.sarif
