# docker-compose.yaml

networks:
  django:
    driver: bridge

services:
  grafana-alloy:
    image: grafana/alloy:v1.11.3
    container_name: grafana-alloy
    restart: unless-stopped
    command: ["run", "/etc/alloy/config.alloy"]
    environment:
      - ALLOY_LOKI_URL=https://monitoring.ebsworx.dev/loki/loki/api/v1/push
      - ALLOY_MIMIR_URL=https://monitoring.ebsworx.dev/mimir/api/v1/push
      - ALLOY_TEMPO_URL=https://monitoring.ebsworx.dev/tempo
      - ALLOY_AUTH_USERNAME=monitor
      - ALLOY_AUTH_PASSWORD=bmbm0WlJE9nRog
    volumes:
      - ./config.alloy:/etc/alloy/config.alloy:ro
    networks:
      - django
    ports:
      # OTLP gRPC port (for Django)
      - "4317:4317"
      # OTLP HTTP port (optional)
      - "4318:4318"
      # Alloy UI for debugging (optional)
      - "12345:12345"

  django:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: django-app
    restart: unless-stopped
    # This ensures the agent is ready to receive data before Django starts
    depends_on:
      - grafana-alloy
    environment:
      # --- NO CHANGES HERE ---
      # Your Django app's configuration remains exactly the same.
      # It will send gRPC data to the service now named 'grafana-alloy' on port 4317.
      DJANGO_SETTINGS_MODULE: alloy.settings
      OTEL_SERVICE_NAME: django-test
      # OTEL_SERVICE_NAMESPACE: backend
      OTEL_ENVIRONMENT: local
      # OTLP exporter configuration
      OTEL_EXPORTER_OTLP_ENDPOINT: grafana-alloy:4317
      OTEL_EXPORTER_OTLP_INSECURE: true
      # Batch processing configuration
      # OTEL_BLRP_MAX_EXPORT_BATCH_SIZE: 512
      # OTEL_BLRP_SCHEDULE_DELAY: 5000
      # Logging level
      LOG_LEVEL: INFO
      OTEL_METRICS_EXPORT_INTERVAL: 100
      # OTEL_EXPORTER_OTLP_ENDPOINT: grafana-alloy:4317
      # OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      # OTEL_TRACES_EXPORTER: otlp
      # OTEL_METRICS_EXPORTER: otlp
      # OTEL_LOGS_EXPORTER: otlp
      # OTEL_EXPORTER_OTLP_INSECURE: "true"
      # OTEL_RESOURCE_ATTRIBUTES: deployment.environment=local
      # OTEL_TRACES_SAMPLER: parentbased_traceidratio
      # OTEL_TRACES_SAMPLER_ARG: "0.1"
    networks:
      - django
    ports:
      - "8000:8000"

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    deploy:
      restart_policy:
        condition: any
    privileged: true
    networks:
    - django

