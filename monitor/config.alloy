otelcol.receiver.otlp "default" {
  grpc { endpoint = "0.0.0.0:4317" }
  http { endpoint = "0.0.0.0:4318" }

  output {
    logs    = [otelcol.processor.batch.default.input]
    metrics = [otelcol.processor.batch.default.input]
    traces  = [otelcol.processor.batch.default.input]
  }
}

otelcol.processor.batch "default" {
  output {
    logs    = [otelcol.processor.attributes.service.input]
    metrics = [otelcol.processor.attributes.service.input]
    traces  = [otelcol.processor.attributes.service.input]
  }
}

otelcol.processor.attributes "service" {
  action {
    key    = "service.name"
    action = "upsert"
    value  = sys.env("OTEL_SERVICE_NAME")
  }
  action {
    key    = "deployment.environment"
    action = "upsert"
    value  = sys.env("OTEL_ENVIRONMENT")
  }
  action {
    key    = "loki.resource.labels"
    action = "insert"
    value  = "service.name,deployment.environment"
  }
  output {
    logs    = [otelcol.exporter.loki.default.input]
    metrics = [otelcol.exporter.prometheus.default.input]
    traces  = [otelcol.exporter.otlphttp.default.input]
  }
}

otelcol.exporter.loki "default" {
  forward_to = [loki.write.lgtm.receiver]
}

loki.write "lgtm" {
  endpoint {
    url = sys.env("ALLOY_LOKI_URL")
    basic_auth {
      username = sys.env("ALLOY_AUTH_USERNAME")
      password = sys.env("ALLOY_AUTH_PASSWORD")
    }
		remote_timeout = "2s"
		min_backoff_period = "500ms"
		max_backoff_period = "5m"
		max_backoff_retries = 10
		batch_wait = "1s"
		batch_size = "1MiB"
  }
}

otelcol.exporter.prometheus "default" {
  forward_to = [prometheus.remote_write.lgtm.receiver]
}

prometheus.remote_write "lgtm" {
  endpoint {
    url = sys.env("ALLOY_MIMIR_URL")
    basic_auth {
      username = sys.env("ALLOY_AUTH_USERNAME")
      password = sys.env("ALLOY_AUTH_PASSWORD")
    }
    remote_timeout = "30s"
    queue_config {
      batch_send_deadline  = "2s"
      max_samples_per_send = 2000
      min_shards = 1
      max_shards = 50
      min_backoff = "100ms"
      max_backoff = "2s"
      capacity = 10000
    }
  }
}

otelcol.connector.spanmetrics "default" {
  dimension {
    name    = "http.method"
    default = "GET"
  }
  histogram {
    explicit {
      buckets = ["50ms","100ms","250ms","1s","5s","10s"]
    }
  }
  metrics_flush_interval = "15s"
  namespace                = "traces.spanmetrics"
  output {
    metrics = [otelcol.exporter.prometheus.default.input]
  }
}

otelcol.exporter.otlphttp "default" {
  client {
    endpoint = sys.env("ALLOY_TEMPO_URL")
    auth     = otelcol.auth.basic.default.handler
    compression = "gzip"
    timeout   = "10s"
  }
}

prometheus.scrape "cadvisor" {
  targets = [
    { "__address__" = "cadvisor:8080" },
  ]
  forward_to = [prometheus.relabel.cadvisor_labels.receiver]
}

prometheus.relabel "cadvisor_labels" {
  forward_to = [prometheus.remote_write.remote.receiver]
  
  rule {
    action       = "replace"
    target_label = "env"
    replacement  = "local"
  }

  rule {
    action       = "replace"
    target_label = "service"
    replacement  = "django-local"
  }

  rule {
    action       = "replace"
    target_label = "job"
    replacement  = "cadvisor"
  }
}

prometheus.remote_write "remote" {
  endpoint {
    url = sys.env("ALLOY_MIMIR_URL")
    basic_auth {
      username = sys.env("ALLOY_AUTH_USERNAME")
      password = sys.env("ALLOY_AUTH_PASSWORD")
    }
  }
}

otelcol.auth.basic "default" {
  username = sys.env("ALLOY_AUTH_USERNAME")
  password = sys.env("ALLOY_AUTH_PASSWORD")
}
